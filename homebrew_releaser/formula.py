import re
from typing import Any, Dict, List, Optional

import chevron
import woodchips

from homebrew_releaser.constants import LOGGER_NAME


class Formula:
    @staticmethod
    def generate_formula_data(
        owner: str,
        repo_name: str,
        repository: Dict[str, Any],
        checksums: List[Dict[str, str]],
        install: str,
        tar_url: str,
        depends_on: Optional[str] = None,
        test: Optional[str] = None,
        matrix: Optional[Dict[str, Any]] = {},
    ) -> str:
        """Generates the formula data for Homebrew.

        We attempt to ensure generated formula will pass `brew audit --strict --online` if given correct inputs:
        - Proper class name
        - 80 characters or less desc field (alphanumeric characters and does not start with an article)
        - Present homepage
        - URL points to the tar file
        - Checksum matches the url archive
        - Proper installable binary
        - Test is included
        - No version attribute if Homebrew can reliably infer the version from the tar URL (GitHub tag)
        """
        logger = woodchips.get(LOGGER_NAME)

        max_desc_field_length = 80  # `brew audit` wants no more than 80 characters in the desc field

        class_name = re.sub(r'[-_. ]+', '', repo_name.title())
        license_type = repository['license']['spdx_id']
        description = re.sub(r'[.!]+', '', repository['description'][:max_desc_field_length]).strip().capitalize()

        # If the first word of the desc is an article, we cut it out per `brew audit`
        articles = {
            'a',
            'an',
            'the',
        }
        first_word_of_desc = description.split(' ', 1)
        if first_word_of_desc[0].lower() in articles:
            description = first_word_of_desc[1].strip().capitalize()

        dependencies_object = {
            'dependencies': [],
        }
        dependencies_list = dependencies_object['dependencies']
        if depends_on:
            dependencies = [dependency.strip() for dependency in depends_on.split('\n') if dependency]

            # `brew audit` wants dependencies sorted
            for dependency in sorted(dependencies):
                dependencies_list.append({'dependency': dependency})

        darwin_amd64_url = None
        darwin_amd64_checksum = None
        darwin_arm64_url = None
        darwin_arm64_checksum = None
        linux_amd64_url = None
        linux_amd64_checksum = None
        linux_arm64_url = None
        linux_arm64_checksum = None
        final_matrix_output = ''
        for checksum in checksums:
            checksum_filename = next(iter(checksum))

            # Autogenerated tar URL is the first one
            autogenerate_tar_checksum = checksums[0][f'{repo_name}.tar.gz']['checksum']

            if checksum[checksum_filename]['url'].endswith('darwin-amd64.tar.gz') and matrix['darwin']['amd64'] is True:
                darwin_amd64_url = checksum[checksum_filename]['url']
                darwin_amd64_checksum = checksum[checksum_filename]['checksum']
            elif (
                checksum[checksum_filename]['url'].endswith('darwin-arm64.tar.gz') and matrix['darwin']['arm64'] is True
            ):
                darwin_arm64_url = checksum[checksum_filename]['url']
                darwin_arm64_checksum = checksum[checksum_filename]['checksum']
            elif checksum[checksum_filename]['url'].endswith('linux-amd64.tar.gz') and matrix['linux']['amd64'] is True:
                linux_amd64_url = checksum[checksum_filename]['url']
                linux_amd64_checksum = checksum[checksum_filename]['checksum']
            elif checksum[checksum_filename]['url'].endswith('linux-arm64.tar.gz') and matrix['linux']['arm64'] is True:
                linux_arm64_url = checksum[checksum_filename]['url']
                linux_arm64_checksum = checksum[checksum_filename]['checksum']

        # Ruby template data MUST remain double spaced to conform to `brew audit`.
        # You may notice some template checks have a line break after the opening tag, this is to ensure
        # we only add that line break when that section is present.
        template = """# typed: false
# frozen_string_literal: true

# This file was generated by Homebrew Releaser. DO NOT EDIT.
class {{class_name}} < Formula
  desc "{{description}}"
  homepage "https://github.com/{{owner}}/{{repo_name}}"
  url "{{tar_url}}"
  sha256 "{{autogenerate_tar_checksum}}"
  license "{{license_type}}"

  {{# dependencies}}
  depends_on {{{dependency}}}
  {{/ dependencies}}
  {{# darwin}}

  on_macos do
    {{# darwin_amd64_url}}
    on_intel do
      url "{{darwin_amd64_url}}"
      sha256 "{{darwin_amd64_checksum}}"
    end
    {{/ darwin_amd64_url}}
    {{# darwin_arm64_url}}

    on_arm do
      url "{{darwin_arm64_url}}"
      sha256 "{{darwin_arm64_checksum}}"
    end
    {{/ darwin_arm64_url}}
  end
  {{/ darwin}}
  {{# linux}}

  on_linux do
    {{# linux_amd64_url}}
    on_intel do
      url "{{linux_amd64_url}}"
      sha256 "{{linux_amd64_checksum}}"
    end
    {{/ linux_amd64_url}}
    {{# linux_arm64_url}}

    on_arm do
      url "{{linux_arm64_url}}"
      sha256 "{{linux_arm64_checksum}}"
    end
    {{/ linux_arm64_url}}
  end
  {{/ linux}}

  def install
    {{{install_instructions}}}
  end
  {{# test_instructions}}

  test do
    {{{test_instructions}}}
  end
  {{/ test_instructions}}
end
"""

        linux = True if matrix and matrix.get('linux') else False
        darwin = True if matrix and matrix.get('darwin') else False

        template_data = {
            'template': template,
            'data': {
                'class_name': class_name,
                'description': description,
                'owner': owner,
                'repo_name': repo_name,
                'tar_url': tar_url,
                'autogenerate_tar_checksum': autogenerate_tar_checksum,
                'license_type': license_type,
                'final_matrix_output': final_matrix_output if final_matrix_output else None,
                'dependencies': dependencies_list,
                'install_instructions': install.strip(),
                'test_instructions': test.strip() if test else None,
                'darwin_amd64_url': darwin_amd64_url,
                'darwin_amd64_checksum': darwin_amd64_checksum,
                'darwin_arm64_url': darwin_arm64_url,
                'darwin_arm64_checksum': darwin_arm64_checksum,
                'linux_amd64_url': linux_amd64_url,
                'linux_amd64_checksum': linux_amd64_checksum,
                'linux_arm64_url': linux_arm64_url,
                'linux_arm64_checksum': linux_arm64_checksum,
                'linux': linux if matrix else None,
                'darwin': darwin if matrix else None,
                'matrix': matrix,
            },
        }

        # TODO: We replace the multiple newlines here for shortcomings in the chevron template above so that
        # `brew audit` passes correctly.
        rendered_template = (
            chevron.render(**template_data)
            .replace('\n\n\n  def install', '\n\n  def install')
            .replace('\n\n\n  on_macos', '\n\n  on_macos')
            .replace('\n\n\n  on_linux', '\n\n  on_linux')
        )

        logger.debug('Homebrew formula generated successfully.')

        return rendered_template
